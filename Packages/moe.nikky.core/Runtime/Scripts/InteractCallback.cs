using nikkyai.common;
using Texel;
using UdonSharp;
using UnityEngine;

namespace nikkyai
{
    [UdonBehaviourSyncMode(BehaviourSyncMode.None)]
    public class InteractCallback : ACLBase
    { 
        [SerializeField, HideInInspector] private int index;

        public int Index
        {
            get => index;
            set => index = value;
        }
        
        protected override string LogPrefix => nameof(InteractCallback);


        public const int EVENT_INTERACT = 0;

        public const int EVENT_RELEASE = 1;
        const int EVENT_COUNT = 2;

        protected override int EventCount
        {
            get => EVENT_COUNT;
        }

        void Start()
        {
            _EnsureInit();
        }

        protected override void AccessChanged()
        {
            DisableInteractive = !isAuthorized;
        }

        private bool _isInteracting = false;
        public override void Interact()
        {
            if (_isInteracting) return;
            if (!isAuthorized) return;
            _isInteracting = true;
            Log($"interact on {index}");
            _UpdateHandlers(EVENT_INTERACT, index);
        }

        public override void InputUse(bool value, VRC.Udon.Common.UdonInputEventArgs args)
        {
            if (!_isInteracting) return;
            if (!isAuthorized) return;
            if (!value)
            {
                _isInteracting = false;
                _UpdateHandlers(EVENT_RELEASE, index);
            }
        }
    }
}